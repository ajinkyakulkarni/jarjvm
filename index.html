<!DOCTYPE html>
<html lang="en">
	<head>
		<script type="text/javascript" src="Util.js"></script>
		<script type="text/javascript" src="Stack.js"></script>
		<script type="text/javascript" src="console.js"></script>
		<LINK href="indexStyle.css" rel="stylesheet" type="text/css" />
		
		<title>JAR JVM</title>
	</head>
	<body onload="consoleInit()">
		<div id="main">
			<div id="header">
				JAR JVM 
			</div>
			<div id="upload">
				<div id="instructions">
					<ul>
						<li>Upload the Java class files needed to run your program.  The file selection box will let you select multiple files</li>
						<li>If you need help with the console type 'help'</li>
						<li>To execute your program type 'execute className'.  ClassName must contain a main function.  '.class' should not be included.</li>
					</ul></div>
				<form><input type="file" id="files" size="50" name="files[]" multiple /></form>
			</div>
			<div id="program">
				<div id="consoleContainer">
					<div id="console" tabindex="1" onkeypress="userTyped(event)">

					</div>
				</div>
				<div id="stackContainer">
					<div id="stack" tabindex="2">
					</div>
				</div>
				<div style="clear:both">  </div>
			</div>
		<output id="list"></output>
		<br />
		<br />
		<script type="text/javascript">
			/** Include all of our scripts **/
			//NOTE: Stack is included above because we use it for a global.
			include("Primitive.js");
			include("JavaObject.js");
			include("JavaScriptStackTrace.js");
			include("Attributes.js");
			include("ByteCode.js");
			include("Class.js");
			include("ConstantPoolInfo.js");
			include("Deflate.js");
			include("FieldInfo.js");
			include("Frame.js");
			include("MethodInfo.js");
			include("MethodRun.js");
			include("Instruction.js");
			include("Descriptor.js");
			include("NativeFunctions.js");
			include("Long.js");
			include("JavaClassReader.js");
		
			DEBUG = false; //USED to turn off console text except for WARNING, ERROR, and OUTPUT
		
			STACK = new Stack();
			CLASSES = new Array();
			// Program Counter
			PC = 0;
			// Current Constant Pool
			CONSTANTPOOL = undefined;
			// Set to 'true' when a context switch is about to occur.
			// Reset just before a method call.
			CONTEXTSWITCH = false;

			Exception = {
				EXCEPTION : 1,
				METHOD_CALL : 2,
				RETURNING : 3,
				CATCH_FOUND : 4
			};

			//HACK
			SYSTEMINITIALIZED = false;

			function handleFileSelect(evt) {
				//Initialize system.
				printTextToConsole("Loading User Classes");
				
				if (!SYSTEMINITIALIZED)
				{
					var systemClass = Class.getClass("java/lang/System");
					MethodRun.callFromNative("java/lang/System", "initializeSystemClass", "()V");
					SYSTEMINITIALIZED = true;	
				}
				debugPrintToConsole("System Initialized");
				var files = evt.target.files;
				// FileList object

				for(var i = 0, f; f = files[i]; i++) {

					var reader = new FileReader();

					reader.onloadend = function(evt) {
						if(evt.target.readyState == FileReader.DONE) {
							printTextToConsole("File Read In");
							var bytes = evt.target.result;
							var javaClassReader = new JavaClassReader(bytes);
							var aClass = new Class(javaClassReader);
							assert(javaClassReader.index == javaClassReader.data.length);
							promptForUserInput();
						}
					};

					//reader.readAsArrayBuffer(f);
					reader.readAsBinaryString(f);
				}
			}


			document.getElementById('files').addEventListener('change', handleFileSelect, false);

		</script>
		</div>
	</body>
</html>
