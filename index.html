<!DOCTYPE html>
<html lang="en">
	<head>
		<script type="text/javascript" src="Util.js"></script>
		<script type="text/javascript" src="Stack.js"></script>
		<script type="text/javascript" src="console.js"></script>
		<script type="text/javascript" src="Shell.js"></script>
		<LINK href="indexStyle.css" rel="stylesheet" type="text/css" />
		
		<title>JAR JVM</title>
	</head>
	<body>
		<div class="main">
			<div class="headerDiv">
				JAR JVM 
			</div>
			<div id="upload" class="upload">
				<div class="instructions">
					<ul>
						<li>Upload the Java class files needed to run your program.  The file selection box will let you select multiple files</li>
						<li>If you need help with the console type 'help'</li>
						<li>To execute your program type 'execute className'.  ClassName must contain a main function.  '.class' should not be included.</li>
					</ul></div>
				<form><input type="file" id="files" size="50" name="files[]" multiple /></form>
			</div>
			<div id="program" class="program">
				<div id="consoleContainer" class="consoleContainer">
					<div id="console" class="console" tabindex="1" onkeypress="CONSOLE.keyEvent(event, false)" onkeydown="CONSOLE.keyEvent(event, true)">

					</div>
				</div>
				<div id="stackContainer" class="stackContainer">
					<div id="stack" tabindex="2" class="stack">
					</div>
				</div>
				<div style="clear:both">  </div>
			</div>
		<output id="list"></output>
		<br />
		<br />
		<script type="text/javascript">
			/** Include all of our scripts **/
			//NOTE: Stack is included above because we use it for a global.
			include("Primitive.js");
			include("JavaObject.js");
			include("JavaScriptStackTrace.js");
			include("Attributes.js");
			include("ByteCode.js");
			include("Class.js");
			include("ConstantPoolInfo.js");
			include("Deflate.js");
			include("FieldInfo.js");
			include("Frame.js");
			include("NativeFunctions.js");
			include("MethodInfo.js");
			include("MethodRun.js");
			include("Instruction.js");
			include("Descriptor.js");
			include("Long.js");
			include("JavaClassReader.js");

			//TODO: Refactor into closure.
			CONSOLE = new Console("console");
			/*** Register all of the shell commands ***/
			//TODO: Refactor into a closure.
			SHELL = new Shell(CONSOLE, "Welcome the the JAR Javascript JVM!\nIf you need help with this console type 'help' and press Enter\n--------------------------------------------------------------------------------\n");
			SHELL.registerCommand(SHELL); //'help' command.
			SHELL.registerCommand(new ShellCommand("test", "Debug", "A test command that prints back the arguments fed to it.", commandTest));
			SHELL.registerCommand(new ShellCommand("execute", "Java", "Execute the specified Java program.", execute));
			SHELL.registerCommand(new ShellCommand("listloadedclasses", "Java", "List all of the currently loaded Java classes.", listLoadedClasses));
			SHELL.registerCommand(new ShellCommand("clearstack", "Debug", "Clear the Java stack.", clearstack));
			SHELL.registerCommand(new ShellCommand("toggledebug", "Debug", "Toggle debugging output (greatly slows down execution speed).", toggleDebug));
			SHELL.registerCommand(new ShellCommand("printmethod", "Debug", "Print the bytecode of the specified method. Specify the full classname, method name, and descriptor as arguments.", printMethod));

		
			/**
			 * Prevent Chrome from going back a page when backspace is hit.
			 */
			function suppressBackspace(evt) {
			    evt = evt || window.event;
			    var target = evt.target || evt.srcElement;

			    if ((evt.keyCode === 8 || evt.keyCode === Console.specialCharacters.UP || evt.keyCode === Console.specialCharacters.DOWN ||
			    	evt.keyCode === Console.specialCharacters.END || evt.keyCode === Console.specialCharacters.HOME) && 
			    	!/input|textarea/i.test(target.nodeName)) {
			        return false;
			    }
			}

			document.onkeydown = suppressBackspace;
			document.onkeypress = suppressBackspace;

			DEBUG = false; //USED to turn off console text except for WARNING, ERROR, and OUTPUT
			LAST_INSERT_CURSOR = false;
			INNERHTML_BEFORE_CURSOR = "";
			STACK = new Stack();
			CLASSES = new Array();
			// Program Counter
			PC = 0;
			// Current Constant Pool
			CONSTANTPOOL = undefined;
			// Set to 'true' when a context switch is about to occur.
			// Reset just before a method call.
			CONTEXTSWITCH = false;

			Exception = {
				EXCEPTION : 1,
				METHOD_CALL : 2,
				RETURNING : 3,
				CATCH_FOUND : 4
			};

			//HACK
			SYSTEMINITIALIZED = false;

			function handleFileSelect(evt) {
				//Initialize system.
				printTextToConsole("Loading User Classes...\n");
				
				if (!SYSTEMINITIALIZED)
				{
					var systemClass = Class.getClass("java/lang/System");
					MethodRun.callFromNative("java/lang/System", "initializeSystemClass", "()V");
					SYSTEMINITIALIZED = true;	
				}
				debugPrintToConsole("System Initialized\n");
				var files = evt.target.files;
				// FileList object

				for(var i = 0, f; f = files[i]; i++) {

					var reader = new FileReader();

					reader.onloadend = function(evt) {
						if(evt.target.readyState == FileReader.DONE) {
							printTextToConsole("File Read In");
							var bytes = evt.target.result;
							var javaClassReader = new JavaClassReader(bytes);
							var aClass = new Class(javaClassReader);
							assert(javaClassReader.index == javaClassReader.data.length);
						}
					};

					//reader.readAsArrayBuffer(f);
					reader.readAsBinaryString(f);
				}
			}


			document.getElementById('files').addEventListener('change', handleFileSelect, false);

		</script>
		</div>
	</body>
</html>
